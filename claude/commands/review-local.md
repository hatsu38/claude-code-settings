---
allowed-tools: Bash(git diff:*), Bash(git log:*), Bash(git status:*), Bash(git stash:*)
description: PRをオープンする前に、ローカルの変更をセルフレビューする
---

PRをオープンする前に、ローカルの変更内容をレビューする。問題を発見した場合は修正案を提示する。

**すべての出力は日本語で記述すること。**

## 手順

1. 現在のブランチの状態を確認する
   - `git status` で未コミットの変更を確認
   - ベースブランチ（master）からの差分を `git diff master...HEAD` で取得
   - `git log master..HEAD --oneline` でコミット履歴を取得
   - `git diff master...HEAD --name-only` で変更ファイル一覧を取得

2. CLAUDE.md を読み込み、プロジェクトのルールを把握する

3. **3つのagentを並列で起動**してレビューする：

   Agent 1: バグ・ロジック検証（sonnet agent）
   - 変更差分から明らかなバグ、不正なロジック、エッジケースの見落としを検出
   - Railsの規約違反（N+1クエリ、マイグレーション不整合など）
   - テストの不足や不備

   Agent 2: CLAUDE.md準拠チェック（sonnet agent）
   - CLAUDE.mdのルールに対する違反を検出
   - プロジェクト固有の規約チェック

   Agent 3: セキュリティ・パフォーマンス（sonnet agent）
   - セキュリティ問題（SQL injection、XSS、認証/認可の不備など）
   - パフォーマンス問題（N+1クエリ、不要な全件取得など）
   - ハードコードされたシークレットや機密情報

4. 各agentの結果を統合し、以下の形式でレポートを出力する：

   ```
   ## セルフレビュー結果

   ### 変更サマリー
   - 変更ファイル数、追加/削除行数
   - 変更の概要

   ### 問題（要対応）
   🔴 CRITICAL: ...
   🟡 HIGH: ...

   ### 注意点（任意対応）
   🟢 MEDIUM: ...

   ### チェックリスト
   - [ ] テストが追加/更新されている
   - [ ] 不要なデバッグコードが残っていない
   - [ ] マイグレーションがある場合、ロールバックを確認した
   ```

5. CRITICALまたはHIGHの問題が見つかった場合：
   - 該当ファイルと行番号を明示する
   - 具体的な修正案を提示する
   - ユーザーに修正するか確認する

6. 問題がない場合：
   「PRをオープンしても問題ありません」と報告する

## レビュー基準

報告すべき：
- 実行時エラーを引き起こすバグ
- セキュリティ脆弱性
- CLAUDE.mdの明確な違反
- テストの不足（新機能やバグ修正にテストがない）
- N+1クエリなど明確なパフォーマンス問題

報告しない：
- スタイルの好み（リンターが対応するもの）
- 既存コードの問題（今回の変更に起因しないもの）
- 「かもしれない」レベルの懸念
- 過度なリファクタリング提案
