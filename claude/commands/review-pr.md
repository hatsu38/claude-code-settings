---
allowed-tools: Bash(gh pr view:*), Bash(gh pr diff:*), Bash(gh pr comment:*), Bash(gh api:*), Bash(gh pr list:*), Bash(git log:*), Bash(git diff:*)
description: GitHub上のPRをコードレビューする
---

指定されたPull Requestのコードレビューを行う。`github-pr-review-operation` スキルを操作に使用する。

**すべての出力・コメントは日本語で記述すること。**

## PR番号の特定

- 引数 `$ARGUMENTS` が指定されていればそれをPR番号として使う
- 指定がなければ `gh pr view --json number -q .number` で現在のブランチのPRを自動検出する

## レビュー手順

1. haiku agentを起動し、以下のいずれかに該当するか確認する：
   - PRがクローズ済み
   - PRがドラフト
   - 自動生成PRなど明らかにレビュー不要な変更
   該当する場合はレビューを中止する。

2. haiku agentを起動し、CLAUDE.mdファイルのパス一覧を取得する：
   - ルートの CLAUDE.md
   - PRで変更されたファイルのディレクトリにある CLAUDE.md

3. sonnet agentを起動し、PRの変更内容のサマリーを作成する

4. **4つのagentを並列で起動**し、独立してレビューする。各agentは問題リスト（説明 + フラグ理由）を返す：

   Agent 1 + 2: CLAUDE.md準拠チェック（sonnet agent × 2、並列）
   変更がCLAUDE.mdのルールに準拠しているか監査する。

   Agent 3: バグ検出（opus agent、Agent 4と並列）
   diffのみから明らかなバグをスキャンする。重大なバグのみフラグし、nitpickや誤検知の可能性が高いものは無視する。

   Agent 4: コード品質・セキュリティ（opus agent、Agent 3と並列）
   導入されたコードの問題を探す。セキュリティ問題、不正なロジックなど。変更されたコード内のみを対象とする。

   **重要: HIGH SIGNALな問題のみを報告する**

   報告すべき：
   - 実行時に不正な動作を引き起こす客観的なバグ
   - CLAUDE.mdの明確な違反（該当ルールを引用できるもの）

   報告しない：
   - 主観的な懸念や「提案」
   - CLAUDE.mdに明示されていないスタイルの好み
   - 「かもしれない」レベルの潜在的問題
   - 解釈や判断が必要なもの
   - 既存コードの問題（今回の変更に起因しないもの）
   - リンターが検出する問題

5. Agent 3, 4が発見した問題ごとに、**検証用agentを並列起動**する。各agentは問題が本当に正しいか高い確信度で検証する。

6. 検証で確認されなかった問題を除外する。

7. 問題が見つかった場合 → ステップ8でインラインコメントを投稿する。
   問題が見つからなかった場合 → `gh pr comment` でサマリーコメントを投稿する：

   ---
   ## コードレビュー

   問題は見つかりませんでした。バグとCLAUDE.mdの準拠を確認しました。

   ---

8. 各問題について `gh api` でインラインコメントを投稿する：
   - `path`: ファイルパス
   - `line`（範囲指定時は `start_line` も）: 問題のある行を選択
   - `body`: 問題の簡潔な説明（日本語）

   小さな修正（5行以下）の場合、committableなsuggestionを含める：
   ```suggestion
   修正後のコード
   ```

   大きな修正（6行以上、構造的な変更）の場合、suggestionブロックは使わず：
   1. 問題の説明
   2. 修正案の概要
   3. Claude Codeで修正するためのプロンプト：
      ```
      [file:line]を修正: [問題と修正案の簡潔な説明]
      ```

   **1つの問題につきコメントは1つだけ。重複コメントを投稿しない。**
